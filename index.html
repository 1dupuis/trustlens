<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TrustLens AI Enhanced</title>
  <!-- Font Awesome & Animate.css for icons/animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <style>
    /* IMPORT FONT */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* ==========================================================================  
       ROOT VARIABLES & GLOBAL SETTINGS -
       ========================================================================== */
    :root {
      --primary: #fe2c55;
      --primary-hover: #ff4d70;
      --secondary: #25f4ee;
      --background: #121212;
      --surface: #1e1e1e;
      --text: #ffffff;
      --text-secondary: #a8a8a8;
      --trust-high: #22c55e;
      --trust-medium: #f59e0b;
      --trust-low: #ef4444;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.05);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --font-base: 'Inter', sans-serif;
      --border-radius: 8px;
      --modal-radius: 20px 20px 0 0;
      --padding: 1rem;
    }

    /* ==========================================================================  
       GLOBAL RESET & BASE STYLES
       ========================================================================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: var(--font-base);
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
      overflow: hidden;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }

    /* ==========================================================================  
       MAIN CONTAINER & SCROLL SETTINGS
       ========================================================================== */
    .app-container {
      width: 100%;
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      scroll-behavior: smooth;
      position: relative;
      scrollbar-width: none;
    }
    .app-container::-webkit-scrollbar {
      display: none;
    }

    /* ==========================================================================  
       VIDEO FEED & CONTAINERS
       ========================================================================== */
    #videos {
      display: flex;
      flex-direction: column;
    }
    .video-container {
      position: relative;
      height: 100vh;
      scroll-snap-align: start;
      background: var(--surface);
      overflow: hidden;
      will-change: transform;
    }
    .video-container iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ==========================================================================  
       VIDEO INFO OVERLAY & TEXT STYLES
       ========================================================================== */
    .video-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1.5rem;
      background: linear-gradient(transparent, rgba(0, 0, 0, 0.95));
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .user-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--glass-bg);
      border: 2px solid var(--primary);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }
    .username {
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .caption {
      font-size: 1rem;
      margin-bottom: 0.5rem;
      line-height: 1.6;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    .video-stats {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
    }

    /* ==========================================================================  
       AI ANALYSIS CARD, TRUST SCORE, SUMMARY & DETAILED ANALYSIS
       ========================================================================== */
    .ai-analysis {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      animation: fadeIn 0.3s ease;
      box-shadow: var(--shadow);
    }
    .trust-score {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-weight: 500;
      cursor: pointer;
    }
    .trust-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      position: relative;
      box-shadow: 0 0 10px currentColor;
    }
    .trust-indicator::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      border-radius: 50%;
      background: inherit;
      opacity: 0.3;
      animation: pulse 2s infinite;
    }
    .high-trust {
      background: var(--trust-high);
      color: var(--trust-high);
    }
    .medium-trust {
      background: var(--trust-medium);
      color: var(--trust-medium);
    }
    .low-trust {
      background: var(--trust-low);
      color: var(--trust-low);
    }
    .ai-explanation {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      letter-spacing: 0.01em;
      display: none;
    }
    /* Video Summary */
    .ai-summary {
      margin-top: 1rem;
    }
    .summary-btn {
      background: var(--primary);
      border: none;
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.9rem;
    }
    .summary-btn:hover {
      background: var(--primary-hover);
    }
    .summary-content {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: none;
    }

    /* ==========================================================================  
       SIDE ACTION BUTTONS (LIKE, COMMENT, FACT-CHECK, ANALYSIS, CHANNEL)
       ========================================================================== */
    .side-actions {
      position: absolute;
      right: 1rem;
      bottom: 11.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      z-index: 10;
      padding: 0.25rem;
    }
    .action-button {
      background: none;
      border: none;
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.375rem;
      cursor: pointer;
      transition: var(--transition);
      padding: 0.25rem;
    }
    .action-button:hover {
      transform: scale(1.1);
    }
    .action-button:active {
      transform: scale(0.95);
    }
    .action-icon {
      width: 56px;
      height: 56px;
      background: var(--glass-bg);
      border: 2px solid var(--glass-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transition: var(--transition);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .like-btn.liked .action-icon {
      background: var(--primary);
      border-color: var(--primary-hover);
      color: var(--trust-high);
      box-shadow: 0 0 15px var(--primary);
    }
    .action-button:hover .action-icon {
      background: var(--primary);
      border-color: var(--primary-hover);
      transform: translateY(-2px);
    }
    .action-count {
      font-size: 0.85rem;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* ==========================================================================  
       NAVIGATION BAR
       ========================================================================== */
    .navigation {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: var(--surface);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      border-top: 1px solid var(--glass-border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      box-shadow: 0 -1px 10px rgba(0, 0, 0, 0.2);
    }
    .nav-item {
      color: var(--text-secondary);
      text-decoration: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      transition: var(--transition);
      padding: 0.5rem 1rem;
      border-radius: var(--border-radius);
    }
    .nav-item:hover {
      color: var(--text);
      transform: translateY(-2px);
      background: var(--glass-bg);
    }
    .nav-icon {
      font-size: 1.2rem;
    }
    .nav-item.active {
      color: var(--primary);
      position: relative;
    }
    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -0.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 0.25rem;
      height: 0.25rem;
      background: var(--primary);
      border-radius: 50%;
    }

    /* ==========================================================================  
       MODAL SECTIONS: COMMENTS, LIKED VIDEOS, SEARCH & DETAILED ANALYSIS
       ========================================================================== */
    .comments-section,
    .liked-videos-section,
    .search-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: var(--modal-radius);
      padding: 1.5rem;
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
    }
    .comments-section,
    .liked-videos-section {
      height: 70%;
      transform: translateY(100%);
    }
    .comments-section.show,
    .liked-videos-section.show {
      transform: translateY(0);
    }
    .search-section {
      height: 100%;
      background: var(--background);
      transform: translateY(-100%);
    }
    .search-section.show {
      transform: translateY(0);
    }
    .comments-header,
    .liked-videos-header,
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--glass-border);
    }
    .comments-title,
    .liked-videos-title,
    .search-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .close-comments,
    .close-liked-videos,
    .close-search {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }
    .close-comments:hover,
    .close-liked-videos:hover,
    .close-search:hover {
      background: var(--glass-bg);
      transform: rotate(90deg);
    }

    /* --------------------------------------------------------------------------
       NEW: Detailed Analysis Modal (for video/channel analysis)
       -------------------------------------------------------------------------- */
    .detailed-analysis-section {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: var(--modal-radius);
      padding: 1.5rem;
      transition: var(--transition);
      z-index: 1000;
      overflow-y: auto;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      height: 70%;
      transform: translateY(100%);
    }
    .detailed-analysis-section.show {
      transform: translateY(0);
    }
    .detailed-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--glass-border);
    }
    .detailed-analysis-title {
      font-weight: 600;
      font-size: 1.1rem;
    }
    .close-detailed-analysis {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: var(--transition);
    }
    .close-detailed-analysis:hover {
      background: var(--glass-bg);
      transform: rotate(90deg);
    }
    #copyAnalysis {
      background: var(--primary);
      border: none;
      color: #fff;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      margin-top: 1rem;
      display: block;
    }
    #copyAnalysis:hover {
      background: var(--primary-hover);
    }

    /* ==========================================================================  
       COMMENTS LIST & COMMENT ITEMS
       ========================================================================== */
    #commentsList {
      max-height: 60%;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding-right: 0.5rem;
    }
    .comment {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 0.5rem;
      border-radius: 12px;
      animation: slideInUp 0.3s ease;
      transition: var(--transition);
    }
    .comment:hover {
      background: var(--glass-bg);
    }
    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--glass-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      border: 1px solid var(--glass-border);
    }
    .comment-content {
      flex: 1;
    }
    .comment-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .comment-username {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .comment-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .comment-text {
      line-height: 1.4;
      margin-bottom: 0.5rem;
    }
    .new-comment {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
    }
    .new-comment input {
      flex: 1;
      padding: 0.75rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border);
      background: var(--surface);
      color: var(--text);
      font-size: 0.9rem;
      transition: var(--transition);
    }
    .new-comment input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-hover);
    }
    .new-comment button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    .new-comment button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }
    .new-comment button:active {
      transform: translateY(0);
    }

    /* ==========================================================================  
       LIKED VIDEOS SECTION
       ========================================================================== */
    #likedVideosList .liked-video {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
    }
    #likedVideosList .liked-video:hover {
      background: var(--glass-bg);
      transform: translateX(8px);
    }
    .liked-video-thumbnail {
      width: 120px;
      height: 68px;
      border-radius: var(--border-radius);
      object-fit: cover;
    }
    .liked-video-info {
      flex: 1;
    }
    .liked-video-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .liked-video-channel {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* ==========================================================================  
       SEARCH SECTION
       ========================================================================== */
    .search-input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--glass-bg);
      border-radius: 12px;
      border: 1px solid var(--glass-border);
    }
    .search-input-container input {
      flex: 1;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border);
      background: var(--surface);
      color: var(--text);
      font-size: 0.95rem;
      transition: var(--transition);
    }
    .search-input-container input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-hover);
    }
    .search-input-container button {
      padding: 0.75rem 1.5rem;
      border: none;
      background: var(--primary);
      color: #fff;
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .search-input-container button:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
    }
    .search-input-container button:active {
      transform: translateY(0);
    }
    #searchResults {
      overflow-y: auto;
      padding: 0 0.75rem;
    }
    .search-result {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid transparent;
    }
    .search-result:hover {
      background: var(--glass-bg);
      border-color: var(--glass-border);
      transform: translateX(8px);
    }
    .search-result-thumbnail {
      width: 160px;
      height: 90px;
      border-radius: var(--border-radius);
      object-fit: cover;
    }
    .search-result-info {
      flex: 1;
      color: var(--text);
    }
    .search-result-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      font-size: 1rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .search-result-channel {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ==========================================================================  
       ANIMATIONS
       ========================================================================== */
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.5); opacity: 0.1; }
      100% { transform: scale(1); opacity: 0.3; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .loader {
      width: 24px;
      height: 24px;
      border: 3px solid var(--text);
      border-bottom-color: transparent;
      border-radius: 50%;
      display: inline-block;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ==========================================================================  
       CUSTOM SCROLLBAR (WEBKIT)
       ========================================================================== */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track {
      background: var(--surface);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--glass-bg);
      border-radius: 4px;
      border: 2px solid var(--surface);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--glass-border);
    }

    /* ==========================================================================  
       RESPONSIVE DESIGN & DEVICE FIT
       ========================================================================== */
    @media (max-width: 1024px) {
      .video-info { padding: 1rem; }
      .side-actions { right: 0.75rem; bottom: 10rem; }
      .action-icon { width: 52px; height: 52px; font-size: 1.3rem; }
    }
    @media (max-width: 768px) {
      .search-result-thumbnail { width: 120px; height: 68px; }
      .video-info { padding: 0.75rem; }
      .side-actions { right: 0.5rem; bottom: 9rem; }
      .action-icon { width: 48px; height: 48px; font-size: 1.2rem; }
    }
    @media (max-width: 480px) {
      .search-result-thumbnail { width: 100px; height: 56px; }
      .search-result-title { font-size: 0.9rem; }
      .video-info { padding: 0.5rem; }
      .user-avatar { width: 36px; height: 36px; }
      .username { font-size: 1rem; }
      .side-actions { right: 0.25rem; bottom: 8.5rem; }
    }
  </style>
</head>
<body>
  <!-- Main app container -->
  <div class="app-container">
    <div id="videos"></div>
    <div id="sentinel"></div>
  </div>

  <!-- Comments Section -->
  <div class="comments-section" id="commentsSection">
    <div class="comments-header">
      <div class="comments-title">Comments</div>
      <button class="close-comments" id="closeComments"><i class="fas fa-times"></i></button>
    </div>
    <!-- Comments Sentiment Analysis -->
    <div class="comments-sentiment">
      <button id="analyzeComments">Analyze Comments Sentiment</button>
      <div id="commentsSentimentResult"></div>
    </div>
    <div id="commentsList"></div>
    <div class="new-comment">
      <input type="text" id="commentInput" placeholder="Add a comment...">
      <button id="submitComment">Post</button>
    </div>
  </div>

  <!-- Liked Videos Section -->
  <div class="liked-videos-section" id="likedVideosSection">
    <div class="liked-videos-header">
      <div class="liked-videos-title">Liked Videos</div>
      <button class="close-liked-videos" id="closeLikedVideos"><i class="fas fa-times"></i></button>
    </div>
    <div id="likedVideosList"></div>
  </div>

  <!-- Search Section -->
  <div class="search-section" id="searchSection">
    <div class="search-header">
      <div class="search-title">Search Videos</div>
      <button class="close-search" id="closeSearch"><i class="fas fa-times"></i></button>
    </div>
    <div class="search-input-container">
      <input type="text" id="searchInput" placeholder="Enter search query...">
      <button id="executeSearch">Search</button>
    </div>
    <div id="searchResults"></div>
  </div>

  <!-- Detailed Analysis Modal (used for both video and channel analysis) -->
  <div class="detailed-analysis-section" id="detailedAnalysisSection">
    <div class="detailed-analysis-header">
      <div class="detailed-analysis-title">Detailed Analysis</div>
      <button class="close-detailed-analysis" id="closeDetailedAnalysis"><i class="fas fa-times"></i></button>
    </div>
    <div id="detailedAnalysisContent"></div>
    <button id="copyAnalysis" title="Copy analysis to clipboard"><i class="fas fa-copy"></i> Copy Analysis</button>
  </div>

  <!-- Navigation Bar -->
  <div class="navigation">
    <a href="#" class="nav-item active" id="navHome">
      <i class="fas fa-home nav-icon"></i>
      <span>Home</span>
    </a>
    <a href="#" class="nav-item" id="navSearch">
      <i class="fas fa-search nav-icon"></i>
      <span>Search</span>
    </a>
    <a href="#" class="nav-item" id="navLiked">
      <i class="fas fa-heart nav-icon"></i>
      <span>Liked</span>
    </a>
  </div>

  <!-- Load YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    /*****************************************
     * CACHING FUNCTIONS USING LOCALSTORAGE
     *****************************************/
    function cacheAIResponse(key, value, expirationMinutes = 1440) {
      const now = new Date().getTime();
      const item = { value: value, expiry: now + expirationMinutes * 60 * 1000 };
      localStorage.setItem(key, JSON.stringify(item));
    }
    function getCachedAIResponse(key) {
      const itemStr = localStorage.getItem(key);
      if (!itemStr) return null;
      try {
        const item = JSON.parse(itemStr);
        const now = new Date().getTime();
        if (now > item.expiry) {
          localStorage.removeItem(key);
          return null;
        }
        return item.value;
      } catch (e) {
        return null;
      }
    }

    /*****************************************
     * GLOBAL VARIABLES & CONFIGURATION
     *****************************************/
    let players = [];
    let playerIdCounter = 0;
    const API_KEY = 'AIzaSyCTePB1WLpoveNVjyncJ_uCmVutawmUaM0';
    const SEARCH_QUERIES = ["government news", "politics news", "news", "elections news", "technology news", "conspiracy theories"];
    let currentCommentVideoId = null;
    let videoCache = [];

    /*****************************************
     * UTILITY: Shuffle an Array
     *****************************************/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    /*****************************************
     * FETCH VIDEOS FROM YOUTUBE DATA API
     *****************************************/
    async function preloadVideos(batchSize = 50) {
      const query = SEARCH_QUERIES[Math.floor(Math.random() * SEARCH_QUERIES.length)];
      const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${batchSize}&q=${encodeURIComponent(query)}&key=${API_KEY}`;
      try {
        const res = await fetch(searchUrl);
        const data = await res.json();
        if (data.items) {
          const videoIds = data.items.map(item => item.id.videoId).join(",");
          const videos = await fetchVideoDetails(videoIds);
          videoCache = shuffleArray(videos);
        }
      } catch (err) {
        console.error("Preload error:", err);
      }
    }
    async function fetchVideoDetails(videoIds) {
      const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoIds}&key=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.items) {
          return data.items.map(item => ({
            videoId: item.id,
            title: item.snippet.title,
            channelTitle: item.snippet.channelTitle,
            thumbnail: item.snippet.thumbnails.medium.url,
            statistics: item.statistics,
            description: item.snippet.description,
            publishedAt: item.snippet.publishedAt
          }));
        }
        return [];
      } catch (err) {
        console.error("Video details error:", err);
        return [];
      }
    }
    async function searchVideos(query, count = 10) {
      const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=${count}&q=${encodeURIComponent(query)}&key=${API_KEY}`;
      try {
        const res = await fetch(searchUrl);
        const data = await res.json();
        if (data.items) {
          const videoIds = data.items.map(item => item.id.videoId).join(",");
          return await fetchVideoDetails(videoIds);
        }
        return [];
      } catch (err) {
        console.error("Search error:", err);
        return [];
      }
    }

    /*****************************************
     * CREATE A VIDEO CONTAINER ELEMENT
     *****************************************/
    function createVideoContainer(videoData, uniqueId) {
      const container = document.createElement("div");
      container.className = "video-container";
      container.dataset.videoId = videoData.videoId;
      container.dataset.title = videoData.title;
      container.dataset.channel = videoData.channelTitle;
      container.dataset.views = videoData.statistics.viewCount || "0";
      container.dataset.thumbnail = videoData.thumbnail;
      const playerDiv = document.createElement("div");
      playerDiv.id = "player-" + uniqueId;
      container.appendChild(playerDiv);
      const info = document.createElement("div");
      info.className = "video-info";
      info.innerHTML = `
        <div class="user-info">
          <div class="user-avatar">
            <img src="${videoData.thumbnail}" alt="thumbnail" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">
          </div>
          <div>
            <div class="username">@${videoData.channelTitle}</div>
            <div class="caption">${videoData.title}</div>
          </div>
        </div>
        <div class="video-stats">Views: ${videoData.statistics.viewCount || "0"}</div>
        <div class="ai-analysis">
          <div class="trust-score" title="Click to toggle explanation">
            <div class="trust-indicator"></div>
            <span>Rating in progress... <i class="fas fa-spinner loader"></i></span>
          </div>
          <div class="ai-explanation">Loading explanation...</div>
        </div>
        <div class="ai-summary">
          <button class="summary-btn">Show Video Summary</button>
          <div class="summary-content">Loading summary...</div>
        </div>
        <div class="side-actions">
          <button class="action-button like-btn" data-video-id="${videoData.videoId}" title="Like video">
            <div class="action-icon"><i class="fas fa-heart"></i></div>
            <span class="action-count">0</span>
          </button>
          <button class="action-button comments-btn" data-video-id="${videoData.videoId}" title="View comments">
            <div class="action-icon"><i class="fas fa-comment"></i></div>
            <span class="action-count">0</span>
          </button>
          <button class="action-button fact-check" data-video-id="${videoData.videoId}" title="Verify content">
            <div class="action-icon"><i class="fas fa-check-circle"></i></div>
            <span class="action-count">Verify</span>
          </button>
          <button class="action-button analysis-btn" data-video-id="${videoData.videoId}" title="Detailed video analysis">
            <div class="action-icon"><i class="fas fa-info-circle"></i></div>
            <span class="action-count">Analysis</span>
          </button>
          <button class="action-button channel-analysis-btn" data-video-id="${videoData.videoId}" title="Analyze channel">
            <div class="action-icon"><i class="fas fa-user-circle"></i></div>
            <span class="action-count">Channel</span>
          </button>
        </div>
      `;
      container.appendChild(info);
      return container;
    }

    /*****************************************
     * INITIALIZE A YOUTUBE PLAYER
     *****************************************/
    function initPlayer(uniqueId, videoData) {
      const player = new YT.Player("player-" + uniqueId, {
        videoId: videoData.videoId,
        playerVars: { autoplay: 0, controls: 1, playsinline: 1, modestbranding: 1, rel: 0 },
        events: {
          onReady: () => {
            const container = document.getElementById("player-" + uniqueId).closest('.video-container');
            player.container = container;
            players.push(player);
          },
          onError: (e) => { console.error("YT Error:", e.data); }
        }
      });
    }

    /*****************************************
     * UPDATE VIDEO TRUST RATING
     *****************************************/
    function updateVideoRating(container, videoData, forceUpdate = false) {
      const analysis = container.querySelector(".ai-analysis");
      const trustScoreSpan = analysis.querySelector(".trust-score span");
      const explanationDiv = analysis.querySelector(".ai-explanation");
      const cacheKey = "ai_rating_" + videoData.videoId;
      const cached = !forceUpdate && getCachedAIResponse(cacheKey);
      if (cached) {
        trustScoreSpan.textContent = `Trust Score: ${cached.rating}% (click for details)`;
        explanationDiv.textContent = cached.explanation;
        updateTrustIndicator(trustScoreSpan, Number(cached.rating));
        return;
      }
      trustScoreSpan.innerHTML = `Rating in progress... <i class="fas fa-spinner loader"></i>`;
      explanationDiv.textContent = "";
      getGeminiRatingAndExplanation(videoData, forceUpdate).then(result => {
        animateRating(trustScoreSpan, 0, result.rating, 1000);
        setTimeout(() => { explanationDiv.textContent = result.explanation; }, 1000);
        cacheAIResponse(cacheKey, result, 1440);
      });
    }

    /*****************************************
     * ANIMATE RATING
     *****************************************/
    function animateRating(ratingElement, start, end, duration) {
      let startTime = null;
      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = timestamp - startTime;
        const ratio = Math.min(progress / duration, 1);
        const current = Math.round(start + (end - start) * ratio);
        ratingElement.textContent = `Trust Score: ${current}%`;
        if (progress < duration) requestAnimationFrame(step);
        else {
          ratingElement.textContent = `Trust Score: ${end}% (click for details)`;
          updateTrustIndicator(ratingElement, end);
        }
      }
      requestAnimationFrame(step);
    }
    function updateTrustIndicator(ratingElement, rating) {
      const indicator = ratingElement.parentElement.querySelector(".trust-indicator");
      indicator.classList.remove("high-trust", "medium-trust", "low-trust");
      if (rating >= 80) indicator.classList.add("high-trust");
      else if (rating >= 50) indicator.classList.add("medium-trust");
      else indicator.classList.add("low-trust");
    }

    /*****************************************
     * AI FEATURES: Gemini API CALLS
     *****************************************/
    async function getGeminiRatingAndExplanation(videoData, forceUpdate = false) {
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const geminiModel = 'gemini-2.0-flash-thinking-exp-01-21';
      const geminiApiKey = 'AIzaSyCnMRMwFGVlPufyLDdEpFG4clySwFB3dBc';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`;
      const promptText = `Evaluate the following YouTube video and provide a structured analysis.
Title: "${videoData.title}"
Channel: "${videoData.channelTitle}"
Thumbnail: ${videoData.thumbnail}
Description: ${videoData.description || "No description available."}
Published At: ${videoData.publishedAt || "Unknown"}
Views: ${videoData.statistics.viewCount || "0"}
Current Date: ${dateStr}

Output format:
Rating: <number from 0-100>
Explanation: <concise explanation in 50 words or less>`;
      const payload = { contents: [ { parts: [ { text: promptText } ] } ] };
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("Gemini API error: " + res.status);
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) throw new Error("No response");
        const output = data.candidates[0].content.parts[0].text;
        const lines = output.split("\n").map(l => l.trim()).filter(Boolean);
        let rating = 0, explanation = "";
        if (lines.length > 0) {
          // Try parsing the first line as a number
          let potentialRating = parseInt(lines[0]);
          if (!isNaN(potentialRating)) {
            rating = potentialRating;
          } else {
            const ratingMatch = lines[0].match(/Rating:\s*(\d+)/i);
            rating = ratingMatch ? Number(ratingMatch[1]) : 0;
          }
          const explMatch = output.match(/Explanation:\s*(.+)/i);
          explanation = explMatch ? explMatch[1] : "No explanation provided.";
        }
        return { rating, explanation };
      } catch (err) {
        console.error("Rating error:", err);
        return { rating: 0, explanation: "Error fetching AI rating." };
      }
    }

    async function getGeminiVideoSummary(videoData) {
      const geminiModel = 'gemini-2.0-flash-thinking-exp-01-21';
      const geminiApiKey = 'AIzaSyCnMRMwFGVlPufyLDdEpFG4clySwFB3dBc';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`;
      const promptText = `Provide a concise summary (50 words or less) for the video.
Title: "${videoData.title}"
Channel: "${videoData.channelTitle}"
Description: "${videoData.description || 'No description available.'}"`;
      const payload = { contents: [ { parts: [ { text: promptText } ] } ] };
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("Gemini API error: " + res.status);
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) throw new Error("No response");
        const output = data.candidates[0].content.parts[0].text;
        return output.split("\n")[0].trim();
      } catch (err) {
        console.error("Summary error:", err);
        return "Error fetching summary.";
      }
    }

    async function getGeminiCommentsSentiment(commentsArray) {
      const geminiModel = 'gemini-2.0-flash-thinking-exp-01-21';
      const geminiApiKey = 'AIzaSyCnMRMwFGVlPufyLDdEpFG4clySwFB3dBc';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`;
      const commentsText = commentsArray.join(" | ");
      const promptText = `Analyze the sentiment of these comments and provide a concise summary (50 words or less):
${commentsText}`;
      const payload = { contents: [ { parts: [ { text: promptText } ] } ] };
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("Gemini API error: " + res.status);
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) throw new Error("No response");
        const output = data.candidates[0].content.parts[0].text;
        return output.split("\n")[0].trim();
      } catch (err) {
        console.error("Sentiment error:", err);
        return "Error analyzing comments.";
      }
    }

    async function getDetailedAIAnalysis(videoData) {
      const geminiModel = 'gemini-2.0-flash-thinking-exp-01-21';
      const geminiApiKey = 'AIzaSyCnMRMwFGVlPufyLDdEpFG4clySwFB3dBc';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`;
      const promptText = `Provide a detailed analysis (100 words or less) of the following video using this format:
---
Credibility Rating: <0-100>
Explanation: <brief explanation>
Misinformation Flags: <if any>
Topics: <list topics>
Fact-check Recommendations: <suggestions>
Summary: <overall summary>
---
Video details:
Title: "${videoData.title}"
Channel: "${videoData.channelTitle}"
Thumbnail: ${videoData.thumbnail}
Description: ${videoData.description || "No description available."}
Views: ${videoData.statistics.viewCount || "0"}`;
      const payload = { contents: [ { parts: [ { text: promptText } ] } ] };
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("Gemini API error: " + res.status);
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) throw new Error("No response");
        return data.candidates[0].content.parts[0].text;
      } catch (err) {
        console.error("Detailed analysis error:", err);
        return "Error fetching detailed analysis.";
      }
    }

    async function getChannelAnalysis(videoData) {
      const geminiModel = 'gemini-2.0-flash-thinking-exp-01-21';
      const geminiApiKey = 'AIzaSyCnMRMwFGVlPufyLDdEpFG4clySwFB3dBc';
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`;
      const promptText = `Analyze the credibility and content quality of the YouTube channel "${videoData.channelTitle}". Consider content consistency, biases, and reputation. Provide your analysis in 50 words or less.`;
      const payload = { contents: [ { parts: [ { text: promptText } ] } ] };
      try {
        const res = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
        if (!res.ok) throw new Error("Gemini API error: " + res.status);
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) throw new Error("No response");
        return data.candidates[0].content.parts[0].text;
      } catch (err) {
        console.error("Channel analysis error:", err);
        return "Error fetching channel analysis.";
      }
    }

    /*****************************************
     * COMMENTS FUNCTIONS
     *****************************************/
    function loadComments(videoId) {
      const commentsList = document.getElementById("commentsList");
      commentsList.innerHTML = "";
      const comments = JSON.parse(localStorage.getItem("comments_" + videoId) || "[]");
      comments.forEach(comment => {
        const el = document.createElement("div");
        el.className = "comment";
        el.innerHTML = `
          <div class="comment-avatar"><i class="fas fa-user"></i></div>
          <div class="comment-content">
            <div class="comment-header">
              <span class="comment-username">You</span>
              <span class="comment-time">${new Date(comment.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `;
        commentsList.appendChild(el);
      });
    }
    function updateCommentCount(videoId) {
      const comments = JSON.parse(localStorage.getItem("comments_" + videoId) || "[]");
      const count = comments.length;
      const btn = document.querySelector(`.comments-btn[data-video-id="${videoId}"]`);
      if (btn) btn.querySelector(".action-count").textContent = count;
    }

    /*****************************************
     * ATTACH TOGGLES FOR SUMMARY & TRUST SCORE
     *****************************************/
    function attachSummaryToggle(container, videoData) {
      const summaryBtn = container.querySelector(".summary-btn");
      const summaryContent = container.querySelector(".summary-content");
      summaryBtn.addEventListener("click", async () => {
        if (summaryContent.style.display === "none" || summaryContent.style.display === "") {
          summaryBtn.textContent = "Loading summary...";
          const summary = await getGeminiVideoSummary(videoData);
          summaryContent.textContent = summary;
          summaryContent.style.display = "block";
          summaryBtn.textContent = "Hide Video Summary";
        } else {
          summaryContent.style.display = "none";
          summaryBtn.textContent = "Show Video Summary";
        }
      });
    }
    function attachTrustScoreToggle(container) {
      const trustScoreElem = container.querySelector(".trust-score");
      if (trustScoreElem) {
        trustScoreElem.style.cursor = "pointer";
        trustScoreElem.addEventListener("click", () => {
          const explanationDiv = container.querySelector(".ai-explanation");
          explanationDiv.style.display = explanationDiv.style.display === "block" ? "none" : "block";
        });
      }
    }

    /*****************************************
     * INTERACTIONS & MODAL HANDLERS
     *****************************************/
    function initInteractions() {
      document.addEventListener("click", (e) => {
        if (e.target.closest(".like-btn")) {
          const btn = e.target.closest(".like-btn");
          const videoId = btn.dataset.videoId;
          const container = btn.closest(".video-container");
          const videoData = {
            videoId: container.dataset.videoId,
            title: container.dataset.title,
            channelTitle: container.dataset.channel,
            thumbnail: container.dataset.thumbnail,
            statistics: { viewCount: container.dataset.views }
          };
          const liked = localStorage.getItem("like_" + videoId) === "true";
          if (liked) {
            localStorage.removeItem("like_" + videoId);
            btn.classList.remove("liked");
            btn.querySelector(".action-count").textContent = "0";
            removeLikedVideo(videoId);
          } else {
            localStorage.setItem("like_" + videoId, "true");
            btn.classList.add("liked");
            btn.querySelector(".action-count").textContent = "1";
            addLikedVideo(videoData);
          }
        }
        if (e.target.closest(".comments-btn")) {
          const btn = e.target.closest(".comments-btn");
          currentCommentVideoId = btn.dataset.videoId;
          loadComments(currentCommentVideoId);
          document.getElementById("commentsSection").classList.add("show");
        }
        if (e.target.closest(".fact-check")) {
          const btn = e.target.closest(".fact-check");
          const container = btn.closest(".video-container");
          const videoData = {
            videoId: container.dataset.videoId,
            title: container.dataset.title,
            channelTitle: container.dataset.channel,
            statistics: { viewCount: container.dataset.views }
          };
          updateVideoRating(container, videoData, true);
        }
        if (e.target.closest(".analysis-btn")) {
          const btn = e.target.closest(".analysis-btn");
          const container = btn.closest(".video-container");
          const videoData = {
            videoId: container.dataset.videoId,
            title: container.dataset.title,
            channelTitle: container.dataset.channel,
            thumbnail: container.dataset.thumbnail,
            statistics: { viewCount: container.dataset.views }
          };
          const modal = document.getElementById("detailedAnalysisSection");
          modal.querySelector(".detailed-analysis-title").textContent = "Detailed Analysis";
          const contentDiv = document.getElementById("detailedAnalysisContent");
          contentDiv.textContent = "Loading detailed analysis...";
          modal.classList.add("show");
          getDetailedAIAnalysis(videoData).then(analysis => {
            contentDiv.textContent = analysis;
          });
        }
        if (e.target.closest(".channel-analysis-btn")) {
          const btn = e.target.closest(".channel-analysis-btn");
          const container = btn.closest(".video-container");
          const videoData = {
            videoId: container.dataset.videoId,
            title: container.dataset.title,
            channelTitle: container.dataset.channel,
            thumbnail: container.dataset.thumbnail,
            statistics: { viewCount: container.dataset.views }
          };
          const modal = document.getElementById("detailedAnalysisSection");
          modal.querySelector(".detailed-analysis-title").textContent = "Channel Analysis";
          const contentDiv = document.getElementById("detailedAnalysisContent");
          contentDiv.textContent = "Loading channel analysis...";
          modal.classList.add("show");
          getChannelAnalysis(videoData).then(analysis => {
            contentDiv.textContent = analysis;
          });
        }
        if (e.target.closest("#navSearch")) {
          document.getElementById("searchSection").classList.add("show");
        }
        if (e.target.closest("#navLiked")) {
          loadLikedVideos();
          document.getElementById("likedVideosSection").classList.add("show");
        }
        if (e.target.closest(".liked-video")) {
          const el = e.target.closest(".liked-video");
          const videoId = el.dataset.videoId;
          const existing = document.querySelector(`.video-container[data-video-id="${videoId}"]`);
          if (existing) existing.scrollIntoView({ behavior: "smooth" });
          else appendVideoToFeed(videoId, el.dataset);
          document.getElementById("likedVideosSection").classList.remove("show");
        }
        if (e.target.closest(".search-result")) {
          const el = e.target.closest(".search-result");
          const videoId = el.dataset.videoId;
          const existing = document.querySelector(`.video-container[data-video-id="${videoId}"]`);
          if (existing) existing.scrollIntoView({ behavior: "smooth" });
          else {
            const videoData = {
              videoId: el.dataset.videoId,
              title: el.dataset.title,
              channelTitle: el.dataset.channel,
              thumbnail: el.dataset.thumbnail,
              statistics: { viewCount: el.dataset.views }
            };
            appendVideoToFeedObj(videoData);
          }
          document.getElementById("searchSection").classList.remove("show");
        }
      });
      document.getElementById("closeComments").addEventListener("click", () => {
        document.getElementById("commentsSection").classList.remove("show");
      });
      document.getElementById("closeLikedVideos").addEventListener("click", () => {
        document.getElementById("likedVideosSection").classList.remove("show");
      });
      document.getElementById("closeSearch").addEventListener("click", () => {
        document.getElementById("searchSection").classList.remove("show");
      });
      document.getElementById("closeDetailedAnalysis").addEventListener("click", () => {
        document.getElementById("detailedAnalysisSection").classList.remove("show");
      });
      document.getElementById("submitComment").addEventListener("click", () => {
        const input = document.getElementById("commentInput");
        const text = input.value.trim();
        if (!text || !currentCommentVideoId) return;
        const comments = JSON.parse(localStorage.getItem("comments_" + currentCommentVideoId) || "[]");
        comments.push({ text, timestamp: Date.now() });
        localStorage.setItem("comments_" + currentCommentVideoId, JSON.stringify(comments));
        input.value = "";
        loadComments(currentCommentVideoId);
        updateCommentCount(currentCommentVideoId);
      });
      document.getElementById("executeSearch").addEventListener("click", async () => {
        const query = document.getElementById("searchInput").value.trim();
        if (!query) return;
        const results = await searchVideos(query, 10);
        displaySearchResults(results);
      });
      document.getElementById("analyzeComments").addEventListener("click", async () => {
        const comments = JSON.parse(localStorage.getItem("comments_" + currentCommentVideoId) || "[]").map(c => c.text);
        if (comments.length === 0) {
          document.getElementById("commentsSentimentResult").textContent = "No comments to analyze.";
          return;
        }
        document.getElementById("commentsSentimentResult").textContent = "Analyzing sentiment...";
        const sentiment = await getGeminiCommentsSentiment(comments);
        document.getElementById("commentsSentimentResult").textContent = sentiment;
      });
      document.getElementById("copyAnalysis").addEventListener("click", () => {
        const text = document.getElementById("detailedAnalysisContent").textContent;
        navigator.clipboard.writeText(text).then(() => {
          alert("Analysis copied to clipboard!");
        });
      });
    }

    function appendVideoToFeedObj(videoData) {
      const container = createVideoContainer(videoData, playerIdCounter++);
      document.getElementById("videos").prepend(container);
      initPlayer(playerIdCounter - 1, videoData);
      if (videoObserver) videoObserver.observe(container);
      if (localStorage.getItem("like_" + videoData.videoId) === "true") {
        const likeBtn = container.querySelector(".like-btn");
        likeBtn.classList.add("liked");
        likeBtn.querySelector(".action-count").textContent = "1";
      }
      const comments = JSON.parse(localStorage.getItem("comments_" + videoData.videoId) || "[]");
      if (comments.length) {
        const commentBtn = container.querySelector(".comments-btn");
        commentBtn.querySelector(".action-count").textContent = comments.length;
      }
      updateVideoRating(container, videoData);
      attachTrustScoreToggle(container);
      attachSummaryToggle(container, videoData);
    }

    async function appendVideoToFeed(videoId, dataAttrs = {}) {
      if (dataAttrs && dataAttrs.title && dataAttrs.channel) {
        const videoData = {
          videoId: dataAttrs.videoId,
          title: dataAttrs.title,
          channelTitle: dataAttrs.channel,
          thumbnail: dataAttrs.thumbnail,
          statistics: { viewCount: dataAttrs.views || "0" }
        };
        appendVideoToFeedObj(videoData);
      } else {
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoId}&key=${API_KEY}`;
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (data.items && data.items.length) {
            const item = data.items[0];
            const videoData = {
              videoId: item.id,
              title: item.snippet.title,
              channelTitle: item.snippet.channelTitle,
              thumbnail: item.snippet.thumbnails.medium.url,
              statistics: item.statistics,
              description: item.snippet.description,
              publishedAt: item.snippet.publishedAt
            };
            appendVideoToFeedObj(videoData);
          }
        } catch (err) {
          console.error("Error appending video:", err);
        }
      }
    }

    function loadLikedVideos() {
      const likedVideos = JSON.parse(localStorage.getItem("likedVideos") || "[]");
      const list = document.getElementById("likedVideosList");
      list.innerHTML = "";
      if (!likedVideos.length) {
        list.innerHTML = "<p>No liked videos yet.</p>";
        return;
      }
      likedVideos.forEach(video => {
        const el = document.createElement("div");
        el.className = "liked-video";
        el.dataset.videoId = video.videoId;
        el.innerHTML = `
          <img src="${video.thumbnail}" alt="thumbnail" class="liked-video-thumbnail">
          <div class="liked-video-info">
            <div class="liked-video-title">${video.title}</div>
            <div class="liked-video-channel">@${video.channelTitle}</div>
          </div>
        `;
        list.appendChild(el);
      });
    }

    function displaySearchResults(results) {
      const container = document.getElementById("searchResults");
      container.innerHTML = "";
      if (!results.length) {
        container.innerHTML = "<p style='color: var(--text);'>No results found.</p>";
        return;
      }
      results.forEach(video => {
        const el = document.createElement("div");
        el.className = "search-result";
        el.dataset.videoId = video.videoId;
        el.dataset.title = video.title;
        el.dataset.channel = video.channelTitle;
        el.dataset.thumbnail = video.thumbnail;
        el.dataset.views = video.statistics.viewCount || "0";
        el.innerHTML = `
          <img src="${video.thumbnail}" alt="thumbnail" class="search-result-thumbnail">
          <div class="search-result-info">
            <div class="search-result-title">${video.title}</div>
            <div class="search-result-channel">@${video.channelTitle}</div>
          </div>
        `;
        container.appendChild(el);
      });
    }

    let videoObserver;
    function initVideoObserver() {
      const options = { root: null, threshold: 0.8 };
      videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          players.forEach(p => {
            if (p.container === entry.target) {
              entry.isIntersecting ? p.playVideo() : p.pauseVideo();
            }
          });
        });
      }, options);
      document.querySelectorAll(".video-container").forEach(container => {
        videoObserver.observe(container);
      });
    }

    function initSentinelObserver() {
      const sentinel = document.getElementById("sentinel");
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            appendRandomVideos(5);
          }
        });
      });
      observer.observe(sentinel);
    }

    async function appendRandomVideos(count = 5) {
      if (videoCache.length < count) await preloadVideos(50);
      const videosToAppend = videoCache.splice(0, count);
      const container = document.getElementById("videos");
      for (const videoData of videosToAppend) {
        appendVideoToFeedObj(videoData);
      }
    }

    function onYouTubeIframeAPIReady() {
      appendRandomVideos(10);
      initVideoObserver();
      initSentinelObserver();
      initInteractions();
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;
  </script>
</body>
</html>
